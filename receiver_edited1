#include <SPI.h>
#include <LoRa.h>

void onReceive(int packetSize) {
  if (packetSize == 0) {
    return; // If no packet received, exit
  }

  // Read packet
  String receivedData = "";
  while (LoRa.available()) {
    receivedData += (char)LoRa.read();
  }

  // Print received data
  Serial.println("Received:");
  Serial.println(receivedData);
}

void setup() {
  Serial.begin(9600);
  
  Serial.println("Initializing LoRa...");
  if (!LoRa.begin(433E6)) { // Ensure the frequency matches your module's specification
    Serial.println("Starting LoRa failed!");
    while (1);
  }
  LoRa.setSyncWord(0x77);
  LoRa.setCodingRate4(5);
  LoRa.setSpreadingFactor(7);
  LoRa.setSignalBandwidth(125E3);

  // Set callback for receiving data
  LoRa.onReceive(onReceive);

  // Enable reception
  LoRa.receive();

  Serial.println("LoRa initialized.");
}

void loop() {
  // Handle other tasks in loop if needed
  // No need to parse packets manually, LoRa.onReceive callback will handle it
  delay(1000); // Adjust delay as needed
}
